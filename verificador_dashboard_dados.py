#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Verificador Final dos Dados do Dashboard
=======================================

Confirma se TODAS as informa√ß√µes est√£o sendo extra√≠das corretamente
do dashboard_data.json e prontas para alimentar o dashboard.
"""

import json
import os
from datetime import datetime


def verificar_dados_dashboard():
    """Verifica detalhadamente os dados do dashboard"""
    print("üîç VERIFICA√á√ÉO FINAL DOS DADOS DO DASHBOARD")
    print("=" * 60)

    if not os.path.exists('dashboard_data.json'):
        print("‚ùå dashboard_data.json n√£o encontrado!")
        return False

    try:
        with open('dashboard_data.json', 'r', encoding='utf-8') as f:
            data = json.load(f)

        print("‚úÖ JSON carregado com sucesso\n")

        # 1. VERIFICAR TIMESTAMP
        print("‚è∞ TIMESTAMP E METADATA:")
        print("-" * 40)
        if 'timestamp' in data:
            timestamp = data['timestamp']
            try:
                dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
                print(f"   üìÖ Gerado em: {dt.strftime('%d/%m/%Y %H:%M:%S')}")
                idade = datetime.now() - dt.replace(tzinfo=None)
                print(f"   ‚è±Ô∏è Idade: {idade}")
            except:
                print(f"   üìÖ Timestamp: {timestamp}")

        # 2. VERIFICAR M√âTRICAS DETALHADAMENTE
        print("\nüìä M√âTRICAS DE PERFORMANCE:")
        print("-" * 40)
        if 'metricas' in data:
            metricas = data['metricas']
            for nome, valores in metricas.items():
                if isinstance(valores, dict):
                    atual = valores.get('atual', 'N/A')
                    original = valores.get('original', 'N/A')
                    melhoria = valores.get('melhoria', 'N/A')

                    # Formata√ß√£o espec√≠fica por m√©trica
                    if nome in ['rmse', 'mae']:
                        atual_fmt = f"{atual:,.0f}" if isinstance(
                            atual, (int, float)) else atual
                        original_fmt = f"{original:,.0f}" if isinstance(
                            original, (int, float)) else original
                    else:
                        atual_fmt = f"{atual:.3f}" if isinstance(
                            atual, (int, float)) else atual
                        original_fmt = f"{original:.3f}" if isinstance(
                            original, (int, float)) else original

                    print(f"   ‚Ä¢ {nome.upper()}:")
                    print(f"     Atual: {atual_fmt}")
                    print(f"     Original: {original_fmt}")
                    print(f"     Melhoria: {melhoria}%")
                    print()
        else:
            print("   ‚ùå Se√ß√£o 'metricas' n√£o encontrada")

        # 3. VERIFICAR FEATURES DETALHADAMENTE
        print("\nüéØ FEATURES SELECIONADAS:")
        print("-" * 40)
        if 'features' in data and isinstance(data['features'], list):
            features = data['features']
            print(f"   üìã Total: {len(features)} features")
            print("\n   üèÜ Detalhamento:")

            for i, feature in enumerate(features, 1):
                if isinstance(feature, dict):
                    nome = feature.get('name', 'N/A')
                    tipo = feature.get('type', 'N/A')
                    imp = feature.get('importance', 'N/A')
                    desc = feature.get('description', 'Sem descri√ß√£o')

                    print(f"      {i:2d}. {nome}")
                    print(f"          Tipo: {tipo}")
                    print(f"          Import√¢ncia: {imp}")
                    print(
                        f"          Descri√ß√£o: {desc[:60]}{'...' if len(desc) > 60 else ''}")
                    print()
        else:
            print("   ‚ùå Features n√£o encontradas ou formato inv√°lido")

        # 4. VERIFICAR INFORMA√á√ïES DO MODELO
        print("\nüèóÔ∏è INFORMA√á√ïES DO MODELO:")
        print("-" * 40)
        if 'modelo' in data:
            modelo = data['modelo']
            spec = modelo.get('especificacao', 'N/A')
            aic = modelo.get('aic', 'N/A')
            bic = modelo.get('bic', 'N/A')
            params = modelo.get('parametros', 'N/A')
            convergiu = modelo.get('convergiu', 'N/A')

            print(f"   üìã Especifica√ß√£o: {spec}")
            print(f"   üìä AIC: {aic}")
            print(f"   üìä BIC: {bic}")
            print(f"   üîß Par√¢metros: {params}")
            print(f"   ‚úÖ Convergiu: {convergiu}")
        else:
            print("   ‚ùå Informa√ß√µes do modelo n√£o encontradas")

        # 5. VERIFICAR CONFIGURA√á√ÉO
        print("\n‚öôÔ∏è CONFIGURA√á√ÉO DO DATASET:")
        print("-" * 40)
        if 'configuracao' in data:
            config = data['configuracao']
            inicio = config.get('periodo_inicio', 'N/A')
            fim = config.get('periodo_fim', 'N/A')
            obs = config.get('total_observacoes', 'N/A')
            target = config.get('target_col', 'N/A')
            exog = config.get('exog_cols', [])

            print(f"   üìÖ Per√≠odo: {inicio} at√© {fim}")
            print(f"   üìä Observa√ß√µes: {obs}")
            print(f"   üéØ Target: {target}")
            print(f"   üìã Ex√≥genas: {exog}")
        else:
            print("   ‚ùå Configura√ß√£o n√£o encontrada")

        # 6. VERIFICAR DADOS OPCIONAIS
        secoes_opcionais = {
            'serie_temporal': 'Dados hist√≥ricos',
            'previsoes': 'Previs√µes futuras',
            'outliers': 'Outliers detectados',
            'comparacao_modelos': 'Compara√ß√£o de modelos'
        }

        print("\nüìã DADOS OPCIONAIS:")
        print("-" * 40)
        for secao, descricao in secoes_opcionais.items():
            if secao in data:
                dados_secao = data[secao]
                if isinstance(dados_secao, list):
                    print(f"   ‚úÖ {descricao}: {len(dados_secao)} itens")
                elif isinstance(dados_secao, dict):
                    print(f"   ‚úÖ {descricao}: {len(dados_secao)} elementos")
                else:
                    print(f"   ‚úÖ {descricao}: Presente")
            else:
                print(f"   ‚ö†Ô∏è {descricao}: Ausente")

        # 7. VERIFICAR COMPATIBILIDADE COM DASHBOARD
        print("\nüåê COMPATIBILIDADE COM DASHBOARD:")
        print("-" * 40)

        checks_dashboard = []

        # Check 1: M√©tricas t√™m formato correto
        if 'metricas' in data:
            metricas_ok = all(
                isinstance(data['metricas'].get(m, {}),
                           dict) and 'atual' in data['metricas'].get(m, {})
                for m in ['rmse', 'mae', 'r2', 'mape']
            )
            checks_dashboard.append(("M√©tricas formatadas", metricas_ok))

        # Check 2: Features t√™m estrutura correta
        if 'features' in data and isinstance(data['features'], list):
            features_ok = all(
                isinstance(f, dict) and 'name' in f and 'importance' in f
                for f in data['features']
            )
            checks_dashboard.append(("Features estruturadas", features_ok))

        # Check 3: Modelo tem informa√ß√µes b√°sicas
        if 'modelo' in data:
            modelo_ok = 'especificacao' in data['modelo'] and 'aic' in data['modelo']
            checks_dashboard.append(("Modelo informado", modelo_ok))

        # Check 4: Timestamp v√°lido
        timestamp_ok = 'timestamp' in data
        checks_dashboard.append(("Timestamp presente", timestamp_ok))

        # Mostrar resultados dos checks
        for check_nome, check_ok in checks_dashboard:
            status = "‚úÖ" if check_ok else "‚ùå"
            print(f"   {status} {check_nome}")

        # Score final
        checks_ok = sum(1 for _, ok in checks_dashboard if ok)
        total_checks = len(checks_dashboard)
        score = (checks_ok / total_checks) * 100

        print(f"\nüéØ SCORE DE COMPATIBILIDADE: {score:.0f}%")
        print(f"‚úÖ Checks OK: {checks_ok}/{total_checks}")

        # 8. SIMULA√á√ÉO DE CARREGAMENTO NO DASHBOARD
        print("\nüîÆ SIMULA√á√ÉO DE CARREGAMENTO NO DASHBOARD:")
        print("-" * 40)

        # Simular o que o JavaScript do dashboard faria
        print("   üìä Dados que aparecer√£o no dashboard:")

        if 'metricas' in data and 'rmse' in data['metricas']:
            rmse = data['metricas']['rmse'].get('atual', 'N/A')
            melhoria = data['metricas']['rmse'].get('melhoria', 'N/A')
            print(f"      RMSE: {rmse:,.0f} ({melhoria:+.1f}% vs anterior)")

        if 'features' in data and len(data['features']) > 0:
            top_feature = data['features'][0]
            nome = top_feature.get('name', 'N/A')
            imp = top_feature.get('importance', 'N/A')
            print(f"      Top Feature: {nome} (import√¢ncia: {imp})")

        if 'modelo' in data:
            spec = data['modelo'].get('especificacao', 'N/A')
            print(f"      Modelo: {spec}")

        print("\nüéâ VERIFICA√á√ÉO CONCLU√çDA!")

        if score >= 100:
            print("‚úÖ PERFEITO! Todos os dados est√£o prontos para o dashboard")
            print("üöÄ Pode abrir o dashboard e carregar os dados com confian√ßa")
        elif score >= 75:
            print("‚úÖ MUITO BOM! Dados est√£o em boa forma")
            print("‚ö†Ô∏è Algumas funcionalidades podem ter limita√ß√µes")
        else:
            print("‚ö†Ô∏è ATEN√á√ÉO! Alguns dados podem estar incompletos")
            print("üîß Recomenda-se executar novamente o modelo")

        return score >= 75

    except json.JSONDecodeError as e:
        print(f"‚ùå Erro ao ler JSON: {e}")
        return False
    except Exception as e:
        print(f"‚ùå Erro na verifica√ß√£o: {e}")
        return False


def main():
    """Fun√ß√£o principal"""
    print("üéØ VERIFICADOR FINAL - DADOS DO DASHBOARD")
    print("=" * 50)
    print("Confirma√ß√£o detalhada de que todos os dados est√£o")
    print("corretamente estruturados para alimentar o dashboard.\n")

    sucesso = verificar_dados_dashboard()

    if sucesso:
        print("\n" + "="*60)
        print("üéä DADOS VALIDADOS COM SUCESSO!")
        print("üåê Agora abra dashboard.html e clique em 'Carregar Dados do JSON'")
        print("üìä Todos os dados reais devem aparecer corretamente!")
        print("="*60)
    else:
        print("\n" + "="*60)
        print("‚ö†Ô∏è PROBLEMAS DETECTADOS NOS DADOS")
        print("üîß Execute novamente o modelo SARIMAX")
        print("="*60)

    return sucesso


if __name__ == "__main__":
    resultado = main()
    exit(0 if resultado else 1)
